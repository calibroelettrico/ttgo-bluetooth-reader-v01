<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TTGO Bluetooth Reader</title>
    <link rel="manifest" href="./manifest.json" />
    <meta name="theme-color" content="#0f172a" />
    <style>
        body { 
            background-color: #0f172a; 
            color: #e2e8f0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        #root {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // --- CONSTANTS ---
        const SERVICE_UUID = "0000181a-0000-1000-8000-00805f9b34fb";
        const CHARACTERISTIC_UUID = "00002a6e-0000-1000-8000-00805f9b34fb";
        const ConnectionStatus = {
            DISCONNECTED: 'DISCONNECTED',
            CONNECTING: 'CONNECTING',
            CONNECTED: 'CONNECTED',
            ERROR: 'ERROR',
        };

        // --- ICONS ---
        const BluetoothIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m7 7 10 10-5 5V2l5 5L7 17" />
            </svg>
        );
        const WifiOffIcon = () => (
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="1" y1="1" x2="23" y2="23" />
                <path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55" />
                <path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39" />
                <path d="M10.71 5.05A16 16 0 0 1 22.58 9" />
                <path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88" />
                <path d="M8.53 16.11a6 6 0 0 1 6.95 0" />
                <line x1="12" y1="20" x2="12.01" y2="20" />
            </svg>
        );

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [connectionStatus, setConnectionStatus] = useState(ConnectionStatus.DISCONNECTED);
            const [device, setDevice] = useState(null);
            const [measurement, setMeasurement] = useState(null);
            const [measurementCount, setMeasurementCount] = useState(0);
            const [error, setError] = useState('');

            const handleNotifications = useCallback((event) => {
                const value = event.target.value;
                if (value.byteLength < 6) {
                    console.error("Received data is too short. Expected 6 bytes.");
                    return;
                }
                
                // 2 byte per la distanza (uint16_t Little Endian)
                const distanceMillimeters = value.getUint16(0, true); 
                // 4 byte per il conteggio (uint32_t Little Endian)
                const count = value.getUint32(2, true);

                const distanceCm = distanceMillimeters / 10.0;
                
                console.log(`Received: ${distanceCm.toFixed(1)} cm, Count: ${count}`);
                setMeasurement(distanceCm);
                setMeasurementCount(count);
            }, []);
            
            const onDisconnected = useCallback(() => {
                console.log('Device disconnected.');
                setDevice(null);
                setConnectionStatus(ConnectionStatus.DISCONNECTED);
                setMeasurement(null);
                setMeasurementCount(0);
            }, []);

            const handleConnect = async () => {
                if (!navigator.bluetooth) {
                    setError("Web Bluetooth API not available on this browser.");
                    setConnectionStatus(ConnectionStatus.ERROR);
                    return;
                }
                setConnectionStatus(ConnectionStatus.CONNECTING);
                setError('');
                try {
                    const btDevice = await navigator.bluetooth.requestDevice({
                        filters: [{ services: [SERVICE_UUID] }],
                        optionalServices: [SERVICE_UUID]
                    });

                    btDevice.addEventListener('gattserverdisconnected', onDisconnected);
                    setDevice(btDevice);

                    const server = await btDevice.gatt.connect();
                    const service = await server.getPrimaryService(SERVICE_UUID);
                    const characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

                    await characteristic.startNotifications();
                    characteristic.addEventListener('characteristicvaluechanged', handleNotifications);
                    
                    setConnectionStatus(ConnectionStatus.CONNECTED);
                    console.log("Connected and listening for notifications...");

                } catch (err) {
                    console.error("Connection failed:", err);
                    setError(err.message);
                    setConnectionStatus(ConnectionStatus.ERROR);
                    setDevice(null);
                }
            };

            const handleDisconnect = () => {
                if (device && device.gatt.connected) {
                    device.gatt.disconnect();
                } else {
                    onDisconnected(); // Cleanup state even if not formally connected
                }
            };

            const renderContent = () => {
                switch (connectionStatus) {
                    case ConnectionStatus.CONNECTED:
                        return (
                            <div style={{ position: 'relative', width: '100%', height: '100vh', display: 'flex', flexDirection: 'column', justifyContent: 'center', alignItems: 'center' }}>
                                {measurementCount > 0 && (
                                    <div style={{ position: 'absolute', top: '2rem', left: '2rem', fontSize: '1.25rem', color: '#94a3b8' }}>
                                        Misurazione n. {measurementCount}
                                    </div>
                                )}
                                {measurement !== null ? (
                                    <div style={{ textAlign: 'center' }}>
                                        <p style={{ fontSize: '7rem', fontWeight: 'bold', margin: 0, lineHeight: 1 }}>
                                            {measurement.toFixed(1)}
                                        </p>
                                        <p style={{ fontSize: '2rem', color: '#94a3b8', margin: 0 }}>cm</p>
                                    </div>
                                ) : (
                                    <p style={{ fontSize: '1.5rem', color: '#64748b' }}>In attesa di misurazione...</p>
                                )}
                                <button
                                    onClick={handleDisconnect}
                                    style={{
                                        position: 'absolute', bottom: '2rem',
                                        background: '#334155', color: 'white',
                                        border: 'none', borderRadius: '50%',
                                        width: '4rem', height: '4rem',
                                        display: 'flex', justifyContent: 'center', alignItems: 'center', cursor: 'pointer'
                                    }}>
                                    <WifiOffIcon />
                                </button>
                            </div>
                        );
                    case ConnectionStatus.CONNECTING:
                        return <p style={{ fontSize: '1.5rem' }}>Connessione in corso...</p>;
                    case ConnectionStatus.ERROR:
                        return (
                            <div style={{ textAlign: 'center', padding: '1rem' }}>
                                <p style={{ fontSize: '1.5rem', color: '#f87171' }}>Errore</p>
                                <p style={{ color: '#fda4af', maxWidth: '300px' }}>{error}</p>
                                <button onClick={() => setConnectionStatus(ConnectionStatus.DISCONNECTED)} style={{ ...buttonStyle, background: '#475569', marginTop: '1rem' }}>
                                    Riprova
                                </button>
                            </div>
                        );
                    default: // DISCONNECTED
                        return (
                            <div style={{ textAlign: 'center' }}>
                                <h1 style={{ fontWeight: 'normal', marginBottom: '2rem' }}>TTGO Reader</h1>
                                <button onClick={handleConnect} style={buttonStyle}>
                                    <BluetoothIcon />
                                    <span style={{ marginLeft: '0.75rem' }}>Connetti Dispositivo</span>
                                </button>
                            </div>
                        );
                }
            };

            const buttonStyle = {
                display: 'inline-flex',
                alignItems: 'center',
                justifyContent: 'center',
                padding: '1rem 2rem',
                backgroundColor: '#3b82f6',
                color: 'white',
                border: 'none',
                borderRadius: '9999px',
                fontSize: '1.125rem',
                cursor: 'pointer',
                boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1)',
                transition: 'background-color 0.2s',
            };

            return (
                <main style={{ width: '100%', maxWidth: '400px', padding: '1rem' }}>
                    {renderContent()}
                </main>
            );
        };

        // --- SERVICE WORKER REGISTRATION ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(registration => {
                    console.log('SW registered: ', registration);
                }).catch(registrationError => {
                    console.log('SW registration failed: ', registrationError);
                });
            });
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
