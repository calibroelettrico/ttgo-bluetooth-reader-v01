<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-t">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTGO Volume Calculator</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-color: #0f172a;
            --text-color: #e2e8f0;
            --primary-color: #38bdf8;
            --secondary-color: #1e293b;
            --border-color: #334155;
            --success-color: #4ade80;
            --error-color: #f87171;
            --warning-color: #facc15;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 1rem;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        #root {
            width: 100%;
            max-width: 800px;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }
        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-connect { background-color: var(--primary-color); color: var(--bg-color); }
        .btn-connect:hover { background-color: #67cff5; }
        .btn-disconnect { background-color: var(--error-color); color: var(--bg-color); }
        .btn-disconnect:hover { background-color: #f98e8e; }
        .btn-save { background-color: var(--success-color); color: var(--bg-color); }
        .btn-save:hover { background-color: #75e89d; }
        .btn:disabled { background-color: var(--border-color); color: #64748b; cursor: not-allowed; }
        
        .status { font-style: italic; color: #94a3b8; text-align: center; }
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            background-color: var(--secondary-color);
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .form-control {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .form-control label {
            font-weight: 500;
        }
        .form-control input {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 1rem;
        }
        .table-container {
            width: 100%;
            overflow-x: auto;
            max-height: 50vh;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        thead {
            position: sticky;
            top: 0;
            background-color: var(--secondary-color);
        }
        tbody tr:nth-child(even) {
            background-color: #1a2436;
        }
        td:nth-child(1), th:nth-child(1) { text-align: center; }
        td:nth-child(2), th:nth-child(2) { text-align: right; }
        td:nth-child(3), th:nth-child(3) { text-align: right; }
        td:nth-child(4), th:nth-child(4) { text-align: right; font-weight: bold; color: var(--primary-color); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const SERVICE_UUID = "0000181a-0000-1000-8000-00805f9b34fb";
        const CHARACTERISTIC_UUID = "00002a6e-0000-1000-8000-00805f9b34fb";
        const CONNECTION_STATUS = {
            DISCONNECTED: 'DISCONNECTED',
            CONNECTING: 'CONNECTING',
            CONNECTED: 'CONNECTED',
            ERROR: 'ERROR'
        };

        function App() {
            const [connectionStatus, setConnectionStatus] = useState(CONNECTION_STATUS.DISCONNECTED);
            const [device, setDevice] = useState(null);
            const [tableData, setTableData] = useState([]);
            const [fileName, setFileName] = useState('');
            const [lengthCm, setLengthCm] = useState('');

            useEffect(() => {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('sw.js').catch(err => {
                        console.error('Service Worker registration failed:', err);
                    });
                }
            }, []);
            
            const handleConnect = async () => {
                if (!navigator.bluetooth) {
                    alert('Web Bluetooth API non è disponibile su questo browser.');
                    return;
                }
                setConnectionStatus(CONNECTION_STATUS.CONNECTING);
                try {
                    const btDevice = await navigator.bluetooth.requestDevice({
                        filters: [{ services: [SERVICE_UUID] }],
                    });
                    setDevice(btDevice);
                    btDevice.addEventListener('gattserverdisconnected', onDisconnect);
                    const server = await btDevice.gatt.connect();
                    const service = await server.getPrimaryService(SERVICE_UUID);
                    const characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
                    await characteristic.startNotifications();
                    characteristic.addEventListener('characteristicvaluechanged', handleNotifications);
                    setConnectionStatus(CONNECTION_STATUS.CONNECTED);
                } catch (error) {
                    console.error('Errore di connessione Bluetooth:', error);
                    setConnectionStatus(CONNECTION_STATUS.ERROR);
                }
            };
            
            const handleDisconnect = () => {
                if (device && device.gatt.connected) {
                    device.gatt.disconnect();
                } else {
                   onDisconnect();
                }
            };

            const onDisconnect = () => {
                setDevice(null);
                setConnectionStatus(CONNECTION_STATUS.DISCONNECTED);
                setTableData([]); // Pulisce i dati alla disconnessione
            };

            const handleNotifications = (event) => {
                const value = event.target.value;
                if (value.byteLength < 6) return; // Controllo di sicurezza

                const diameterMm = value.getUint16(0, true); // Little Endian
                const measurementCount = value.getUint32(2, true); // Little Endian
                
                const diameterCm = (diameterMm / 10.0).toFixed(1);
                const currentLength = parseFloat(lengthCm) || 0;
                const radius = parseFloat(diameterCm) / 2;
                const volume = (Math.PI * Math.pow(radius, 2) * currentLength).toFixed(2);

                const newRow = {
                    num: measurementCount,
                    diameter: diameterCm,
                    length: currentLength.toFixed(1),
                    volume: volume,
                };

                setTableData(prevData => [...prevData, newRow]);
            };

            const handleSaveFile = () => {
                if (tableData.length === 0) return;

                // Prepara i dati per SheetJS
                const headers = ["Num", "Diametro", "Lunghezza", "Volume"];
                const dataForSheet = tableData.map(row => [row.num, row.diameter, row.length, row.volume]);
                
                const worksheet = XLSX.utils.aoa_to_sheet([headers, ...dataForSheet]);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Misure");

                const finalFileName = (fileName.trim() || `misure_TTGO_${new Date().toISOString().slice(0, 10)}`) + ".ods";

                // Genera e scarica il file
                XLSX.writeFile(workbook, finalFileName, { bookType: "ods" });
            };

            return (
                <div className="container">
                    <header className="header">
                        <h1>TTGO Volume Calculator</h1>
                        {connectionStatus !== CONNECTION_STATUS.CONNECTED ? (
                            <button className="btn btn-connect" onClick={handleConnect} disabled={connectionStatus === CONNECTION_STATUS.CONNECTING}>
                                {connectionStatus === CONNECTION_STATUS.CONNECTING ? 'Connessione...' : 'Connetti Dispositivo'}
                            </button>
                        ) : (
                            <button className="btn btn-disconnect" onClick={handleDisconnect}>Disconnetti</button>
                        )}
                    </header>
                    
                    {connectionStatus !== CONNECTION_STATUS.CONNECTED && (
                        <p className="status">
                            {connectionStatus === CONNECTION_STATUS.DISCONNECTED && "Premi 'Connetti' per iniziare."}
                            {connectionStatus === CONNECTION_STATUS.CONNECTING && "In attesa di connessione al dispositivo..."}
                            {connectionStatus === CONNECTION_STATUS.ERROR && "Connessione fallita. Riprova."}
                        </p>
                    )}

                    {connectionStatus === CONNECTION_STATUS.CONNECTED && (
                        <>
                            <div className="input-group">
                                <div className="form-control">
                                    <label htmlFor="filename">Nome file:</label>
                                    <input 
                                        type="text" 
                                        id="filename" 
                                        value={fileName} 
                                        onChange={(e) => setFileName(e.target.value)} 
                                        placeholder="Es: log_misure_01"
                                    />
                                </div>
                                <div className="form-control">
                                    <label htmlFor="length">Lunghezza cm:</label>
                                    <input 
                                        type="number" 
                                        id="length" 
                                        value={lengthCm} 
                                        onChange={(e) => setLengthCm(e.target.value)} 
                                        placeholder="Es: 150.5"
                                    />
                                </div>
                            </div>

                            <button className="btn btn-save" onClick={handleSaveFile} disabled={tableData.length === 0}>
                                Salva File (.ods)
                            </button>
                            
                            <div className="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Num</th>
                                            <th>Diametro (cm)</th>
                                            <th>Lunghezza (cm)</th>
                                            <th>Volume (cm³)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {tableData.length > 0 ? (
                                            tableData.map((row) => (
                                                <tr key={row.num}>
                                                    <td>{row.num}</td>
                                                    <td>{row.diameter}</td>
                                                    <td>{row.length}</td>
                                                    <td>{row.volume}</td>
                                                </tr>
                                            ))
                                        ) : (
                                            <tr>
                                                <td colSpan="4" style={{ textAlign: 'center', padding: '2rem' }}>
                                                    In attesa di misurazioni dal dispositivo...
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
