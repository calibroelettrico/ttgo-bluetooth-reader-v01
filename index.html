<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TTGO Bluetooth Reader</title>
    
    <!-- Link al Manifest -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0f172a">

    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
      }
    }
    </script>
  </head>
  <body class="bg-slate-900">
    <div id="root"></div>

    <script type="module">
      import React, { useState, useCallback, useRef, useEffect, StrictMode } from 'react';
      import ReactDOM from 'react-dom/client';

      // --- Constants ---
      const TTGO_SERVICE_UUID = '0000181a-0000-1000-8000-00805f9b34fb';
      const MEASUREMENT_CHARACTERISTIC_UUID = '00002a6e-0000-1000-8000-00805f9b34fb';
      const ConnectionStatus = {
        DISCONNECTED: 'DISCONNECTED',
        CONNECTING: 'CONNECTING',
        CONNECTED: 'CONNECTED',
        ERROR: 'ERROR',
      };

      // --- Icons ---
      const BluetoothIcon = ({ className }) => (
        React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('path', { d: 'm7 7 10 10-5 5V2l5 5L7 17' })
        )
      );

      const LinkIcon = ({ className }) => (
        React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('path', { d: 'M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72' }),
          React.createElement('path', { d: 'M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72' })
        )
      );

      const UnlinkIcon = ({ className }) => (
        React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('path', { d: 'M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72' }),
          React.createElement('path', { d: 'M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72' }),
          React.createElement('line', { x1: '2', y1: '2', x2: '22', y2: '22' })
        )
      );

      // --- MeasurementDisplay Component ---
      const MeasurementDisplay = ({ measurement }) => {
        const MAX_DISPLAY_CM = 200;
        const displayValue = measurement ?? 0;
        const percentage = Math.min((displayValue / MAX_DISPLAY_CM) * 100, 100);

        return (
          React.createElement('div', { className: 'relative w-80 h-80 flex items-center justify-center' },
            React.createElement('svg', { className: 'absolute w-full h-full transform -rotate-90', viewBox: '0 0 120 120' },
              React.createElement('circle', { cx: '60', cy: '60', r: '54', fill: 'none', strokeWidth: '12', className: 'stroke-slate-700' }),
              React.createElement('circle', {
                cx: '60', cy: '60', r: '54', fill: 'none', strokeWidth: '12',
                className: 'stroke-cyan-500 transition-all duration-500 ease-out',
                strokeDasharray: Math.PI * 108,
                strokeDashoffset: Math.PI * 108 * (1 - percentage / 100),
                strokeLinecap: 'round'
              })
            ),
            React.createElement('div', { className: 'z-10 text-center' },
              measurement !== null ? (
                React.createElement(React.Fragment, null,
                  React.createElement('span', { className: 'text-8xl font-bold text-white tracking-tighter' }, measurement.toFixed(1)),
                  React.createElement('span', { className: 'text-3xl font-light text-slate-400 ml-2' }, 'cm')
                )
              ) : (
                React.createElement('span', { className: 'text-4xl font-light text-slate-500' }, '--')
              )
            )
          )
        );
      };

      // --- App Component ---
      const App = () => {
        const [status, setStatus] = useState(ConnectionStatus.DISCONNECTED);
        const [measurement, setMeasurement] = useState(null);
        const [measurementCount, setMeasurementCount] = useState(0);
        const [error, setError] = useState(null);

        const deviceRef = useRef(null);
        const characteristicRef = useRef(null);

        const handleDisconnectEvent = useCallback(() => {
          setStatus(ConnectionStatus.DISCONNECTED);
          setMeasurement(null);
          setMeasurementCount(0); // Reset counter on disconnect
          deviceRef.current = null;
          characteristicRef.current = null;
        }, []);

        useEffect(() => {
          return () => {
            if (deviceRef.current?.gatt?.connected) {
              deviceRef.current.gatt.disconnect();
            }
          };
        }, []);

        const handleConnect = useCallback(async () => {
          if (!navigator.bluetooth) {
            setError("Web Bluetooth API is not available. Try Chrome on Android.");
            setStatus(ConnectionStatus.ERROR);
            return;
          }

          setStatus(ConnectionStatus.CONNECTING);
          setError(null);

          try {
            const device = await navigator.bluetooth.requestDevice({
              filters: [{ services: [TTGO_SERVICE_UUID] }],
              optionalServices: [TTGO_SERVICE_UUID],
            });

            deviceRef.current = device;
            device.addEventListener('gattserverdisconnected', handleDisconnectEvent);
            
            const server = await device.gatt?.connect();
            if (!server) throw new Error("Could not connect to GATT server");

            const service = await server.getPrimaryService(TTGO_SERVICE_UUID);
            const characteristic = await service.getCharacteristic(MEASUREMENT_CHARACTERISTIC_UUID);
            characteristicRef.current = characteristic;

            await characteristic.startNotifications();
            characteristic.addEventListener('characteristicvaluechanged', (event) => {
              const target = event.target;
              const value = target.value;
              // --- MODIFICA CHIAVE: Legge un pacchetto di 6 byte ---
              if (value && value.byteLength >= 6) {
                // Primi 2 byte: misurazione in mm (Little Endian)
                const mmValue = value.getUint16(0, true); 
                const cmValue = mmValue / 10.0;
                
                // Successivi 4 byte: conteggio (Little Endian)
                const countValue = value.getUint32(2, true);

                setMeasurement(cmValue);
                setMeasurementCount(countValue); // Imposta il conteggio ricevuto dalla scheda
              }
            });
            
            setStatus(ConnectionStatus.CONNECTED);

          } catch (err) {
            console.error(err);
            setError(err.message || "Failed to connect.");
            setStatus(ConnectionStatus.ERROR);
          }
        }, [handleDisconnectEvent]);

        const handleDisconnect = useCallback(() => {
          if (deviceRef.current?.gatt?.connected) {
            deviceRef.current.gatt.disconnect();
          } else {
            handleDisconnectEvent();
          }
        }, [handleDisconnectEvent]);

        const renderContent = () => {
          switch (status) {
            case ConnectionStatus.CONNECTING:
              return (
                React.createElement('div', { className: 'text-center' },
                  React.createElement('div', { className: 'animate-spin rounded-full h-16 w-16 border-b-2 border-cyan-500 mx-auto' }),
                  React.createElement('p', { className: 'text-slate-400 mt-4' }, 'Connecting... check for a prompt.')
                )
              );

            case ConnectionStatus.CONNECTED:
              return (
                React.createElement(React.Fragment, null,
                  React.createElement(MeasurementDisplay, { measurement: measurement }),
                  React.createElement('p', { className: 'text-green-400 font-medium my-4 flex items-center' },
                      React.createElement(LinkIcon, { className: 'w-5 h-5 mr-2' }),
                      `Connected to ${deviceRef.current?.name || 'TTGO Device'}`
                  ),
                  React.createElement('button', {
                    onClick: handleDisconnect,
                    className: 'mt-4 px-6 py-3 bg-red-600 text-white font-bold rounded-lg shadow-lg hover:bg-red-700 transition-colors flex items-center'
                  },
                    React.createElement(UnlinkIcon, { className: 'w-5 h-5 mr-2' }),
                    'Disconnect'
                  )
                )
              );

            case ConnectionStatus.ERROR:
              return (
                React.createElement('div', { className: 'text-center p-4 bg-red-900/50 rounded-lg border border-red-700' },
                  React.createElement('p', { className: 'text-red-400 font-bold' }, 'Connection Error'),
                  React.createElement('p', { className: 'text-slate-300 mt-2' }, error),
                  React.createElement('button', {
                    onClick: () => setStatus(ConnectionStatus.DISCONNECTED),
                    className: 'mt-6 px-6 py-2 bg-slate-600 text-white font-bold rounded-lg hover:bg-slate-700 transition-colors'
                  },
                    'Try Again'
                  )
                )
              );
            
            case ConnectionStatus.DISCONNECTED:
            default:
              return (
                React.createElement('div', { className: 'text-center' },
                  React.createElement('h2', { className: 'text-4xl font-bold text-white' }, 'TTGO Bluetooth Reader'),
                  React.createElement('p', { className: 'text-slate-400 mt-2 mb-8' }, 'Ready to receive measurements.'),
                  React.createElement('button', {
                    onClick: handleConnect,
                    className: 'px-8 py-4 bg-cyan-600 text-white text-xl font-bold rounded-full shadow-lg hover:bg-cyan-700 hover:scale-105 transform transition-all duration-300 flex items-center mx-auto'
                  },
                    React.createElement(BluetoothIcon, { className: 'w-6 h-6 mr-3' }),
                    'Connect to Device'
                  )
                )
              );
          }
        };

        return (
          React.createElement('div', { className: 'min-h-screen bg-slate-900 text-white flex flex-col items-center justify-center p-4 font-sans relative' },
              React.createElement('div', { className: 'absolute top-4 left-4' },
                status === ConnectionStatus.CONNECTED && measurementCount > 0 && (
                  React.createElement('p', { className: 'text-slate-400 font-mono text-lg' },
                    `Misurazione n. ${measurementCount}`
                  )
                )
              ),
              React.createElement('div', { className: 'w-full max-w-md flex flex-col items-center justify-center' },
                  renderContent()
              ),
              React.createElement('footer', { className: 'absolute bottom-4 text-center text-slate-600 text-sm' },
                  React.createElement('p', null, 'Ensure your TTGO device is powered on and advertising the correct Bluetooth service.'),
                  React.createElement('p', null, `Service UUID: ${TTGO_SERVICE_UUID}`)
              )
          )
        );
      };

      // --- Render App ---
      const rootElement = document.getElementById('root');
      if (!rootElement) throw new Error('Failed to find the root element');
      const root = ReactDOM.createRoot(rootElement);
      root.render(
        React.createElement(StrictMode, null, React.createElement(App))
      );
    </script>

    <!-- Registrazione del Service Worker -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js').then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, err => {
            console.log('ServiceWorker registration failed: ', err);
          });
        });
      }
    </script>
  </body>
</html>
