<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Misuratore Tronchi PWA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Babel per la transpilazione di JSX direttamente nel browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
  }
}
</script>
</head>
  <body class="bg-gray-900 text-gray-100">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
      import React, { useState, useCallback, useRef, useEffect } from 'react';
      import ReactDOM from 'react-dom/client';

      // --- UUID del servizio e delle caratteristiche Bluetooth ---
      // Devono corrispondere a quelli nel codice Arduino
      const BLE_SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
      const BLE_TX_CHARACTERISTIC_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8"; // PWA -> TTGO
      const BLE_RX_CHARACTERISTIC_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a9"; // TTGO -> PWA

      // --- Componenti React ---

      const Header = () => (
        <header className="text-center mb-4">
            <h1 className="text-4xl font-bold text-cyan-400">Misuratore Tronchi PWA</h1>
            <p className="text-gray-400">Data Logger Bluetooth per TTGO</p>
        </header>
      );

      const StatusIndicator = ({ isConnected, statusText }) => {
        const bgColor = isConnected ? 'bg-green-800' : 'bg-yellow-800';
        const textColor = isConnected ? 'text-green-200' : 'text-yellow-200';
        const dotColor = isConnected ? 'bg-green-400' : 'bg-yellow-400';

        return (
            <div className={`p-3 rounded-lg flex items-center space-x-3 ${bgColor} ${textColor} shadow-md`}>
                <span className={`h-3 w-3 rounded-full ${dotColor} ${isConnected ? 'animate-pulse' : ''}`}></span>
                <span className="font-mono text-sm">{statusText}</span>
            </div>
        );
      }

      const DataForm = ({ fileName, setFileName, length, setLength, disabled }) => (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-800 p-4 rounded-lg shadow-lg">
            <div>
                <label htmlFor="fileName" className="block text-sm font-medium text-gray-300 mb-1">
                    Nome File
                </label>
                <input
                    type="text"
                    id="fileName"
                    value={fileName}
                    onChange={(e) => setFileName(e.target.value)}
                    disabled={disabled}
                    className="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 disabled:opacity-50"
                />
            </div>
            <div>
                <label htmlFor="length" className="block text-sm font-medium text-gray-300 mb-1">
                    Lunghezza (cm)
                </label>
                <input
                    type="number"
                    id="length"
                    value={length}
                    onChange={(e) => setLength(Number(e.target.value))}
                    disabled={disabled}
                    className="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 disabled:opacity-50"
                />
            </div>
        </div>
      );

      const MeasurementsTable = ({ measurements }) => {
        const tableContainerRef = useRef(null);

        useEffect(() => {
            if (tableContainerRef.current) {
                tableContainerRef.current.scrollTop = tableContainerRef.current.scrollHeight;
            }
        }, [measurements]);

        return (
            <div className="flex-grow flex flex-col bg-gray-800 p-4 rounded-lg shadow-lg min-h-[300px]">
                <h2 className="text-xl font-semibold mb-2 text-cyan-400">Misure</h2>
                <div ref={tableContainerRef} className="flex-grow overflow-y-auto">
                    <table className="w-full text-left table-fixed">
                        <thead className="sticky top-0 bg-gray-800">
                            <tr>
                                <th className="w-1/6 p-2 text-sm font-medium text-gray-400">Num</th>
                                <th className="w-1/3 p-2 text-sm font-medium text-gray-400">Diametro (cm)</th>
                                <th className="w-1/4 p-2 text-sm font-medium text-gray-400">Lunghezza (cm)</th>
                                <th className="w-1/4 p-2 text-sm font-medium text-gray-400">Volume (mÂ³)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {measurements.map((m, index) => (
                                <tr key={index} className="border-t border-gray-700 hover:bg-gray-700">
                                    <td className="p-2">{m.num}</td>
                                    <td className="p-2">{m.diameter.toFixed(1)}</td>
                                    <td className="p-2">{m.length}</td>
                                    <td className="p-2">{m.volume}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                     {measurements.length === 0 && (
                        <div className="text-center p-8 text-gray-500">
                            In attesa di misurazioni...
                        </div>
                    )}
                </div>
            </div>
        );
      };

      const Actions = ({ isConnected, onConnect, onDisconnect, onSave }) => (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {!isConnected ? (
                <button
                    onClick={onConnect}
                    className="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-colors duration-200"
                >
                    Connetti
                </button>
            ) : (
                <button
                    onClick={onDisconnect}
                    className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-colors duration-200"
                >
                    Disconnetti
                </button>
            )}
            <button
                onClick={onSave}
                className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-colors duration-200"
            >
                Salva come .csv
            </button>
        </div>
      );

      // --- Componente Principale App ---

      const App = () => {
        const [fileName, setFileName] = useState('tronchi');
        const [length, setLength] = useState(100);
        const [measurements, setMeasurements] = useState([]);
        const [isConnected, setIsConnected] = useState(false);
        const [status, setStatus] = useState('Pronto. Connettersi al dispositivo.');

        const deviceRef = useRef(null);
        const txCharacteristicRef = useRef(null);

        const onDisconnected = useCallback(() => {
            setIsConnected(false);
            setStatus('Dispositivo disconnesso. Riconnettersi se necessario.');
            deviceRef.current = null;
            txCharacteristicRef.current = null;
        }, []);

        const handleDisconnect = useCallback(() => {
            if (deviceRef.current && deviceRef.current.gatt?.connected) {
                deviceRef.current.gatt.disconnect();
            }
        }, []);

        const handleNotifications = useCallback((event) => {
            const value = event.target.value;
            if (!value) return;

            const decoder = new TextDecoder('utf-8');
            const message = decoder.decode(value);

            console.log(`Ricevuto: ${message}`);
            const [command, ...args] = message.split(':');

            if (command === 'DATA') {
                const [numStr, diameterMmStr] = args;
                const num = parseInt(numStr, 10);
                const diameterCm = parseFloat(diameterMmStr) / 10;
                const lengthCm = length;

                const radiusM = (diameterCm / 2) / 100;
                const lengthM = lengthCm / 100;
                const volumeMc = Math.PI * Math.pow(radiusM, 2) * lengthM;
                
                const newMeasurement = {
                    num,
                    diameter: diameterCm,
                    length: lengthCm,
                    volume: parseFloat(volumeMc.toFixed(6))
                };
                
                setMeasurements(prev => [...prev.filter(m => m.num !== num), newMeasurement].sort((a,b) => a.num - b.num));
                setStatus(`Ricevuta misura #${num}`);
            } else if (command === 'DEL_LAST') {
                setMeasurements(prev => prev.slice(0, -1));
                setStatus('Ultima misura cancellata.');
            } else if (command === 'LOG') {
                setStatus(`Dispositivo: ${args.join(':')}`);
            } else if (command === 'CLEAR') {
                setMeasurements([]);
                setStatus('Nuovo file avviato. Tabella pulita.');
            }
        }, [length]);

        const connectToDevice = useCallback(async () => {
            if (!fileName || length <= 0) {
                setStatus('Inserire un Nome File e una Lunghezza validi.');
                return;
            }

            try {
                setStatus('Richiesta dispositivo Bluetooth...');
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [BLE_SERVICE_UUID] }],
                });

                deviceRef.current = device;
                device.addEventListener('gattserverdisconnected', onDisconnected);
                setStatus('Connessione al server GATT...');
                const server = await device.gatt.connect();
                
                setStatus('Ottenimento servizio primario...');
                const service = await server.getPrimaryService(BLE_SERVICE_UUID);

                setStatus('Ottenimento caratteristiche...');
                const txCharacteristic = await service.getCharacteristic(BLE_TX_CHARACTERISTIC_UUID);
                const rxCharacteristic = await service.getCharacteristic(BLE_RX_CHARACTERISTIC_UUID);
                
                txCharacteristicRef.current = txCharacteristic;

                setStatus('Avvio notifiche...');
                await rxCharacteristic.startNotifications();
                rxCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);
                
                setIsConnected(true);
                setStatus('Connesso! In attesa di azione dal dispositivo...');

                const encoder = new TextEncoder();
                const dataToSend = `INIT:${fileName}:${length}`;
                await txCharacteristicRef.current.writeValue(encoder.encode(dataToSend));

            } catch (error) {
                setStatus(`Errore: ${error.message}`);
                console.error('Connessione fallita:', error);
                setIsConnected(false);
                if(deviceRef.current) {
                    deviceRef.current.removeEventListener('gattserverdisconnected', onDisconnected);
                    deviceRef.current = null;
                }
            }
        }, [fileName, length, handleNotifications, onDisconnected]);

        const handleSave = () => {
            if (measurements.length === 0) {
                setStatus('Nessun dato da salvare.');
                return;
            }
            // Converte il separatore decimale in virgola per LibreOffice italiano
            const header = "Num;Diametro(cm);Lunghezza(cm);Volume(mc)\n";
            const csvContent = measurements
                .map(m => `${m.num};${m.diameter.toFixed(1).replace('.',',')};${m.length};${String(m.volume).replace('.',',')}`)
                .join("\n");
            
            const fullCsv = header + csvContent;
            const blob = new Blob([fullCsv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `${fileName}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            setStatus('File salvato con successo.');
        };
        
        useEffect(() => {
            return () => {
                if (deviceRef.current) {
                    deviceRef.current.removeEventListener('gattserverdisconnected', onDisconnected);
                    if (deviceRef.current.gatt?.connected) {
                        deviceRef.current.gatt.disconnect();
                    }
                }
            };
        }, [onDisconnected]);

        return (
            <div className="min-h-screen bg-gray-900 text-gray-200 flex flex-col p-4 font-sans">
                <Header />
                <div className="container mx-auto max-w-4xl flex-grow flex flex-col space-y-4">
                    <StatusIndicator isConnected={isConnected} statusText={status} />
                    <DataForm
                        fileName={fileName}
                        setFileName={setFileName}
                        length={length}
                        setLength={setLength}
                        disabled={isConnected}
                    />
                    <MeasurementsTable measurements={measurements} />
                    <Actions
                        isConnected={isConnected}
                        onConnect={connectToDevice}
                        onDisconnect={handleDisconnect}
                        onSave={handleSave}
                    />
                </div>
            </div>
        );
      };

      // --- Avvio dell'applicazione ---
      const rootElement = document.getElementById('root');
      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
  </body>
</html>
