<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTGO Bluetooth Reader</title>
    <link rel="manifest" href="manifest.json">
    <style>
        /* Basic CSS for the app */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            text-align: center;
        }
        #root {
            width: 100%;
            max-width: 400px;
            padding: 20px;
        }
        button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #2563eb;
        }
        button:disabled {
            background-color: #475569;
            cursor: not-allowed;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        .status {
            font-size: 14px;
            color: #94a3b8;
            height: 20px;
        }
        .measurement-display {
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            background-color: #1e293b;
        }
        .measurement-value {
            font-size: 48px;
            font-weight: bold;
            color: #f8fafc;
        }
        .measurement-unit {
            font-size: 24px;
            color: #94a3b8;
            margin-left: 8px;
        }
        .measurement-count {
            font-size: 18px;
            color: #cbd5e1;
            margin-top: 10px;
        }
        .error {
            color: #f87171;
            margin-top: 10px;
        }
    </style>
    <!-- React, ReactDOM, and Babel for in-browser JSX transformation -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- SheetJS (xlsx.js) library for ODS export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // --- Constants ---
        const SERVICE_UUID = "0000181a-0000-1000-8000-00805f9b34fb";
        const CHARACTERISTIC_UUID = "00002a6e-0000-1000-8000-00805f9b34fb";
        const CONNECTION_STATUS = {
            DISCONNECTED: 'DISCONNECTED',
            CONNECTING: 'CONNECTING',
            CONNECTED: 'CONNECTED',
        };

        function App() {
            const [connectionStatus, setConnectionStatus] = useState(CONNECTION_STATUS.DISCONNECTED);
            const [bluetoothDevice, setBluetoothDevice] = useState(null);
            const [latestMeasurement, setLatestMeasurement] = useState({ value: null, count: null });
            const [measurements, setMeasurements] = useState([]);
            const [error, setError] = useState('');

            // Cleanup on component unmount
            useEffect(() => {
                return () => {
                    if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                        bluetoothDevice.gatt.disconnect();
                    }
                };
            }, [bluetoothDevice]);

            const handleNotifications = useCallback((event) => {
                const value = event.target.value;
                if (value.byteLength < 6) {
                    console.warn("Received data packet is too small.");
                    return;
                }

                // The firmware sends a 6-byte packet:
                // - 2 bytes for distance in mm (uint16_t, little-endian)
                // - 4 bytes for measurement count (uint32_t, little-endian)
                const distanceMm = value.getUint16(0, true); // true for little-endian
                const count = value.getUint32(2, true);      // true for little-endian
                
                const distanceCm = (distanceMm / 10).toFixed(1);

                const newMeasurement = { value: parseFloat(distanceCm), count: count };
                
                console.log(`Received: ${distanceCm} cm, Count: ${count}`);

                setLatestMeasurement(newMeasurement);
                setMeasurements(prevMeasurements => [...prevMeasurements, newMeasurement]);
            }, []);

            const handleConnect = async () => {
                setError('');
                if (!navigator.bluetooth) {
                    setError("Web Bluetooth API non Ã¨ supportato su questo browser.");
                    return;
                }
                
                setConnectionStatus(CONNECTION_STATUS.CONNECTING);
                
                try {
                    const device = await navigator.bluetooth.requestDevice({
                        filters: [{ services: [SERVICE_UUID] }],
                        optionalServices: [SERVICE_UUID]
                    });

                    device.addEventListener('gattserverdisconnected', onDisconnected);
                    setBluetoothDevice(device);
                    
                    const server = await device.gatt.connect();
                    const service = await server.getPrimaryService(SERVICE_UUID);
                    const characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
                    
                    await characteristic.startNotifications();
                    characteristic.addEventListener('characteristicvaluechanged', handleNotifications);
                    
                    setConnectionStatus(CONNECTION_STATUS.CONNECTED);
                    console.log("Connected to", device.name);

                } catch (err) {
                    console.error("Connection failed:", err);
                    setError(`Connessione fallita: ${err.message}`);
                    setConnectionStatus(CONNECTION_STATUS.DISCONNECTED);
                }
            };
            
            const onDisconnected = () => {
                console.log("Device disconnected.");
                setConnectionStatus(CONNECTION_STATUS.DISCONNECTED);
                setBluetoothDevice(null);
                setLatestMeasurement({ value: null, count: null });
                setMeasurements([]); // Reset measurements on disconnect
                setError('');
            };

            const handleDisconnect = () => {
                if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                    bluetoothDevice.gatt.disconnect();
                } else {
                    onDisconnected(); // Manually trigger if already disconnected
                }
            };

            const handleSaveFile = () => {
                if (measurements.length === 0) return;

                // Create header row
                const data = [["Numero", "Misurazione (cm)"]];
                
                // Add measurement rows
                measurements.forEach(m => {
                    data.push([m.count, m.value]);
                });

                // Create a new workbook
                const wb = XLSX.utils.book_new();
                // Convert array of arrays to a worksheet
                const ws = XLSX.utils.aoa_to_sheet(data);
                // Append the worksheet to the workbook
                XLSX.utils.book_append_sheet(wb, ws, "Misure");
                
                const today = new Date().toISOString().slice(0, 10);
                const fileName = `misure_TTGO_${today}.ods`;

                // Write the workbook and trigger download
                XLSX.writeFile(wb, fileName);
            };

            const getStatusText = () => {
                switch(connectionStatus) {
                    case CONNECTION_STATUS.CONNECTING:
                        return 'Connessione in corso...';
                    case CONNECTION_STATUS.CONNECTED:
                        return `Connesso a ${bluetoothDevice?.name || 'dispositivo'}`;
                    default:
                        return 'Disconnesso';
                }
            };

            return (
                <div className="container">
                    <h2>TTGO Bluetooth Reader</h2>
                    <div className="status">{getStatusText()}</div>

                    {connectionStatus !== CONNECTION_STATUS.CONNECTED ? (
                        <button onClick={handleConnect} disabled={connectionStatus === CONNECTION_STATUS.CONNECTING}>
                            Connetti
                        </button>
                    ) : (
                        <button onClick={handleDisconnect}>
                            Disconnetti
                        </button>
                    )}
                    
                    <div className="measurement-display">
                        {latestMeasurement.value !== null ? (
                            <div>
                                <div>
                                    <span className="measurement-value">{latestMeasurement.value}</span>
                                    <span className="measurement-unit">cm</span>
                                </div>
                                <div className="measurement-count">Misurazione N. {latestMeasurement.count}</div>
                            </div>
                        ) : (
                            <div className="measurement-count">In attesa di misurazioni...</div>
                        )}
                    </div>

                    <button onClick={handleSaveFile} disabled={measurements.length === 0}>
                        Salva File (.ods)
                    </button>
                    
                    {error && <p className="error">{error}</p>}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
